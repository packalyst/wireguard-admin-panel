services:
  # ============================================
  # TRAEFIK - Reverse Proxy with API & Dashboard
  # ============================================
  traefik:
    image: traefik:v3.5
    container_name: traefik
    restart: unless-stopped
    ports:
      - "${HTTP_PORT}:80"
      - "${HTTPS_PORT}:443"
      - "${TRAEFIK_PORT}:8080"
    volumes:
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ./traefik/logs:/var/log/traefik
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      vpn-network:
        ipv4_address: 172.18.0.2

  # ============================================
  # HEADSCALE - VPN Control Server (for Tailscale clients)
  # ============================================
  headscale:
    image: headscale/headscale:0.23
    container_name: headscale
    restart: unless-stopped
    command: serve
    volumes:
      - ./headscale/config:/etc/headscale
      - ./headscale/data:/var/lib/headscale
    ports:
      - "${STUN_PORT}:3478/udp"
      - "127.0.0.1:${HEADSCALE_INTERNAL_PORT}:8080"
    cap_add:
      - NET_ADMIN
    networks:
      vpn-network:
        ipv4_address: 172.18.0.3

  # ============================================
  # UNIFIED API - All services in one container
  # Replaces: wg-api, firewall-api
  # Provides: /api/fw, /api/wg, /api/traefik, /api/hs, /api/adguard
  # ============================================
  api:
    build: ./api
    container_name: api
    restart: unless-stopped
    network_mode: host
    pid: host
    privileged: true
    cap_add:
      - NET_ADMIN
    environment:
      # Core settings (hardcoded paths inside container)
      - API_PORT=${API_PORT}
      - DATA_DIR=/data
      - CONFIG_PATH=/app/configs/endpoints.json
      - TRAEFIK_CONFIG=/traefik/dynamic.yml
      - TRAEFIK_STATIC=/traefik/traefik.yml
      - TRAEFIK_LOGS=/traefik/logs/access.log
      # WireGuard settings
      - WG_INTERFACE=${WG_INTERFACE}
      - WG_PORT=${WG_PORT}
      - SERVER_IP=${SERVER_IP}
      - WG_IP_RANGE=${WG_IP_RANGE}
      - WG_SERVER_IP=${WG_SERVER_IP}
      - WG_DNS=${WG_DNS}
      - HEADSCALE_IP_RANGE=${HEADSCALE_IP_RANGE}
      # Traefik settings
      - TRAEFIK_API=${TRAEFIK_API}
      - TRAEFIK_PORT=${TRAEFIK_PORT}
      # AdGuard settings
      - ADGUARD_PORT=${ADGUARD_PORT}
      - ADGUARD_CONFIG=/adguard/AdGuardHome.yaml
      # Firewall settings
      - IGNORE_NETWORKS=${IGNORE_NETWORKS}
    volumes:
      - api_data:/data
      - /var/log:/var/log:ro
      - ./traefik:/traefik
      - ./adguard/conf:/adguard
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # ============================================
  # ADGUARD HOME - DNS Server with Query Logging
  # ============================================
  adguard:
    image: adguard/adguardhome:latest
    container_name: adguard
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./adguard/work:/opt/adguardhome/work
      - ./adguard/conf:/opt/adguardhome/conf

  # ============================================
  # UI - Unified Web Dashboard
  # ============================================
  ui:
    build:
      context: ./ui
      target: production
    container_name: ui
    restart: unless-stopped
    networks:
      vpn-network:
        ipv4_address: 172.18.0.4
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ui.rule=PathPrefix(`/`)"
      - "traefik.http.routers.ui.priority=1"
      - "traefik.http.services.ui.loadbalancer.server.port=80"

volumes:
  api_data:

networks:
  vpn-network:
    name: vpn-network
    ipam:
      driver: default
      config:
        - subnet: 172.18.0.0/24
          gateway: 172.18.0.1
